# This is a main workflow to trigger codescan

name: CI

# Controls when the workflow will run
on:
    push:
      branches:
        - master
    pull_request:
      branches:
        - '*'
jobs:
    build:
      runs-on: ubuntu-20.04
      steps:
        - name: Checkout repository
          uses: actions/checkout@v2
        - name: Changed Files
          uses: jitterbit/get-changed-files@v1
          id: files
          with:
            format: 'csv'
            token: ${{ secrets.GITHUB_TOKEN }}
        - name: Cache files
          uses: actions/cache@v2
          with:
              path: |
                  ~/.sonar
              key: ${{ runner.os }}-sonar
              restore-keys: ${{ runner.os }}-sonar
        - name: Run Codescan On Push
          env:
            JAVA_TOOL_OPTIONS: "-Xmx8g"
          if: github.event_name == 'push'
          uses: codescan-io/codescan-scanner-action@1.3
          with:
            organization: ${{ secrets.codescan_organization }}
            projectKey: ${{ secrets.codescan_projectkey }}      
            login: ${{ secrets.codescan_token }}
            args: |
              sonar.inclusions=${{ steps.files.outputs.added_modified }}
              sonar.exclusions=**/aura/**/*.css,**/lwc/**/*.css,**/analyticscc__*,**/skuid__*,**/agf__*,**/ExAM__*,**/dupcheck__*,**/rh2__*,**/rhx__*,**/cnx*,**/SDOC*,**/rhx*,**/contentassets/**,**/dashboards/**,**/documents/**,**/eclair/**,**/email/**,**/emailservices/**,**/networkBranding/**,**/reports/**,**/wave/**,**/staticresources/*,**/ADM*,**/usf*,**/welkins_table*,**/sortablegrid*,**/CMTD*,**/DynPro*,**/LIMITMON*,**/ca_only*,**/flowmagic*,**/ear*,**/followrpt*,**/MPM4*,**/copado*,**/emptracing*,**/HealthCloudGA
        - name: Run Codescan On PR
          env:
            JAVA_TOOL_OPTIONS: "-Xmx8g"
          if: github.event_name == 'pull_request'
          uses: codescan-io/codescan-scanner-action@1.3
          with:
            organization: ${{ secrets.codescan_organization }}
            projectKey: ${{ secrets.codescan_projectkey }}
            login: ${{ secrets.codescan_token }}
            args: |
              sonar.branch.name=${{github.head_ref}}
              sonar.branch.target=master
              sonar.pullrequest.key=${{github.event.number}}
              sonar.inclusions=${{ steps.files.outputs.added_modified }}
              sonar.exclusions=**/aura/**/*.css,**/lwc/**/*.css,**/analyticscc__*,**/skuid__*,**/agf__*,**/ExAM__*,**/dupcheck__*,**/rh2__*,**/rhx__*,**/cnx*,**/SDOC*,**/rhx*,**/contentassets/**,**/dashboards/**,**/documents/**,**/eclair/**,**/email/**,**/emailservices/**,**/networkBranding/**,**/reports/**,**/wave/**,**/staticresources/*,**/ADM*,**/usf*,**/welkins_table*,**/sortablegrid*,**/CMTD*,**/DynPro*,**/LIMITMON*,**/ca_only*,**/flowmagic*,**/ear*,**/followrpt*,**/MPM4*,**/copado*,**/emptracing*,**/HealthCloudGA
        - name: Upload SARIF file
          uses: github/codeql-action/upload-sarif@v2
          with:
            sarif_file: codescan.sarif
